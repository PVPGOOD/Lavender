package io.justme.lavender.module.impl.exploit.disabler.process;

import io.justme.lavender.utility.math.TimerUtility;
import io.justme.lavender.utility.network.PacketUtility;
import lombok.Getter;
import lombok.Setter;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.C00PacketKeepAlive;
import net.minecraft.network.play.server.S00PacketKeepAlive;

import java.util.Queue;
import java.util.concurrent.ConcurrentLinkedQueue;

/**
 * @author JustMe.
 * @since 2024/5/2
 **/

@Getter
@Setter
public class PacketProcessor {

    public final PacketEnum packetEnum = getPacketEnum();
    public final Queue<Packet<?>> dataQueue = new ConcurrentLinkedQueue<>();
    public final PacketUtility packetUtility = new PacketUtility();
    private final TimerUtility timerUtility = new TimerUtility();

    public void offerPacket(Packet<?> newData) {
        getDataQueue().offer(newData);
    }

    public void processPacket(PacketEnum packetEnum) {
        var data = getDataQueue().poll();
        if (data != null) {
            sendData(data,packetEnum);
        }
    }

    private void sendData(Packet<?> data, PacketEnum packetEnum) {

        switch (packetEnum) {
            case C00 -> {
                if (data instanceof S00PacketKeepAlive keepAlive) {
                    //处理C00
                    if (getTimerUtility().hasTimeElapsed(320,true)) {
                        getPacketUtility().sendPacket(new C00PacketKeepAlive(keepAlive.func_149134_c()));
                    }
                }
            }

            //暂时没好的思路
            case C0F -> {}
            case C0D -> {}
            case C0E -> {}
            case C16 -> {}

            default -> getPacketUtility().sendPacket(data);
        }

    }

    public enum PacketEnum {
        C00,
        C0F,
        C0D,
        C0E,
        C16,
    }
}
